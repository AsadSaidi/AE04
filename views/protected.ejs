<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Página protegida</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .animated-gradient {
      background: linear-gradient(-45deg, #0ea5e9, #2563eb, #3b82f6, #06b6d4);
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
    }
    
    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    tbody tr {
      animation: slideIn 0.3s ease-out;
    }
  </style>
</head>
<body class="animated-gradient min-h-screen p-4 md:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-2xl flex items-center justify-center shadow-lg">
          <span class="text-3xl">🎬</span>
        </div>
        <div>
          <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Películas</h1>
          <p class="text-gray-600 text-sm">Gestiona tu colección de películas</p>
        </div>
      </div>

      <!-- Botón de Series -->
      <div class="flex items-center gap-2 ml-auto">
        <a href="/series" 
          class="bg-green-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-green-600 transition-all">
          📺 Gestionar Series
        </a>
      </div>

      <button id="btn-logout" class="bg-red-500 text-white px-4 py-2 rounded-xl font-semibold hover:bg-red-600 transition-all">
        🔓 Logout
      </button>
    </div>

    <!-- Form -->
    <div class="glass rounded-3xl p-6 md:p-8 mb-6 shadow-2xl fade-in">
      <form id="formPelicula" class="space-y-6">
        <div class="flex items-center justify-between mb-4">
          <h2 id="formTitulo" class="text-2xl font-bold text-gray-800">Agregar Película</h2>
          <button type="button" onclick="cancelarEdicion()" id="btnCancelar" class="hidden text-gray-500 hover:text-gray-700 transition-colors">
            ✕ Cancelar
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="space-y-2">
            <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
            <input 
              type="text" 
              id="nombre" 
              placeholder="Ej: Inception" 
              required 
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>

          <div class="space-y-2">
            <label for="year" class="block text-sm font-medium text-gray-700">Año</label>
            <input 
              type="number" 
              id="year" 
              placeholder="2024" 
              required 
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>

          <div class="space-y-2">
            <label for="genero" class="block text-sm font-medium text-gray-700">Género</label>
            <input 
              type="text" 
              id="genero" 
              placeholder="Ej: Sci-Fi" 
              required 
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>

          <div class="space-y-2">
            <label for="director" class="block text-sm font-medium text-gray-700">Director</label>
            <input 
              type="text" 
              id="director" 
              placeholder="Ej: Christopher Nolan" 
              required 
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>

          <div class="space-y-2">
            <label for="presupuesto" class="block text-sm font-medium text-gray-700">Presupuesto ($)</label>
            <input 
              type="number" 
              id="presupuesto" 
              placeholder="160000000" 
              required 
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>

          <div class="space-y-2">
            <label for="productora" class="block text-sm font-medium text-gray-700">Productora</label>
            <input 
              type="text" 
              id="productora" 
              placeholder="Ej: Warner Bros" 
              required 
              class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl text-gray-800 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            />
          </div>
        </div>

        <button 
          type="submit" 
          class="w-full md:w-auto bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-3 px-8 rounded-xl font-semibold hover:from-blue-600 hover:to-cyan-600 transition-all transform hover:scale-105 shadow-lg"
        >
          💾 Guardar Película
        </button>
      </form>
    </div>

    <!-- Table -->
    <div class="glass rounded-3xl p-6 md:p-8 shadow-2xl fade-in overflow-hidden">
      <div class="overflow-x-auto">
        <table id="tablaPeliculas" class="w-full">
          <thead>
            <tr class="border-b-2 border-gray-200">
              <th class="text-left py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Nombre</th>
              <th class="text-left py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Año</th>
              <th class="text-left py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Género</th>
              <th class="text-left py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Director</th>
              <th class="text-left py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Presupuesto</th>
              <th class="text-left py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Productora</th>
              <th class="text-center py-4 px-4 text-sm font-bold text-gray-700 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="emptyState" class="hidden text-center py-12">
        <div class="text-6xl mb-4">🎬</div>
        <p class="text-gray-500 text-lg">No hay películas todavía</p>
        <p class="text-gray-400 text-sm">Agrega tu primera película usando el formulario</p>
      </div>
    </div>
  </div>

  <!-- Modal Editar Película -->
  <div id="modalEditar" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-3xl p-6 md:p-8 shadow-2xl w-full max-w-lg relative">
      <button id="modalCerrar" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold">✕</button>
      <h2 id="modalTitulo" class="text-2xl font-bold text-gray-800 mb-4">Editar Película</h2>
      <form id="formPeliculaModal" class="space-y-4">
        <input type="text" id="modalNombre" placeholder="Nombre" class="w-full border rounded px-4 py-2" required />
        <input type="number" id="modalYear" placeholder="Año" class="w-full border rounded px-4 py-2" required />
        <input type="text" id="modalGenero" placeholder="Género" class="w-full border rounded px-4 py-2" required />
        <input type="text" id="modalDirector" placeholder="Director" class="w-full border rounded px-4 py-2" required />
        <input type="number" id="modalPresupuesto" placeholder="Presupuesto" class="w-full border rounded px-4 py-2" required />
        <input type="text" id="modalProductora" placeholder="Productora" class="w-full border rounded px-4 py-2" required />
        <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition">💾 Guardar Cambios</button>
      </form>
    </div>
  </div>


  <script>
    const API_URL = '/api/peliculas';
    const tbody = document.querySelector('#tablaPeliculas tbody');

    // Formulario principal
    const form = document.querySelector('#formPelicula');
    const formTitulo = document.querySelector('#formTitulo');
    const btnCancelar = document.querySelector('#btnCancelar');

    // Modal
    const modal = document.getElementById('modalEditar');
    const modalCerrar = document.getElementById('modalCerrar');
    const formModal = document.getElementById('formPeliculaModal');
    const modalNombre = document.getElementById('modalNombre');
    const modalYear = document.getElementById('modalYear');
    const modalGenero = document.getElementById('modalGenero');
    const modalDirector = document.getElementById('modalDirector');
    const modalPresupuesto = document.getElementById('modalPresupuesto');
    const modalProductora = document.getElementById('modalProductora');


    let editId = null;

    async function cargarPeliculas() {
      try {
        const token = localStorage.getItem('token'); // o donde lo guardaste
        const res = await fetch('/api/peliculas', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!res.ok) throw new Error(res.statusText);

        const peliculas = await res.json();
        console.log(peliculas); // ahora sí recibes el array
        mostrarPeliculas(peliculas);

      } catch (error) {
        console.error("Error cargando películas", error);
      }
    }


    function mostrarPeliculas(peliculas) {
      tbody.innerHTML = '';
      
      if (peliculas.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      
      emptyState.classList.add('hidden');
      
      peliculas.forEach(p => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-100 hover:bg-blue-50/50 transition-colors';
        tr.innerHTML = `
          <td class="py-4 px-4">
            <div class="font-semibold text-gray-800">${p.nombre}</div>
          </td>
          <td class="py-4 px-4 text-gray-600">${p.year}</td>
          <td class="py-4 px-4">
            <span class="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">
              ${p.genero}
            </span>
          </td>
          <td class="py-4 px-4 text-gray-600">${p.director}</td>
          <td class="py-4 px-4">
            <span class="font-semibold text-green-600">$${p.presupuesto.toLocaleString()}</span>
          </td>
          <td class="py-4 px-4 text-gray-600">${p.productora}</td>
          <td class="py-4 px-4">
            <div class="flex gap-2 justify-center">
              <button 
                onclick="editarPelicula(${p.id})" 
                class="bg-blue-100 hover:bg-blue-200 text-blue-600 w-10 h-10 rounded-lg transition-all transform hover:scale-110 flex items-center justify-center"
                title="Editar"
              >
                ✏️
              </button>
              <button 
                onclick="eliminarPelicula(${p.id})" 
                class="bg-red-100 hover:bg-red-200 text-red-600 w-10 h-10 rounded-lg transition-all transform hover:scale-110 flex items-center justify-center"
                title="Eliminar"
              >
                🗑️
              </button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const data = {
        nombre: form.nombre.value,
        year: parseInt(form.year.value),
        genero: form.genero.value,
        director: form.director.value,
        presupuesto: parseFloat(form.presupuesto.value),
        productora: form.productora.value
      };

      if (editId === null) {
        await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
      } else {
        await fetch(`${API_URL}/${editId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        cancelarEdicion();
      }

      form.reset();
      cargarPeliculas();
    });

    window.editarPelicula = async (id) => {
      const res = await fetch(`${API_URL}/${id}`);
      const p = await res.json();

      // Llenar inputs del modal
      modalNombre.value = p.nombre;
      modalYear.value = p.year;
      modalGenero.value = p.genero;
      modalDirector.value = p.director;
      modalPresupuesto.value = p.presupuesto;
      modalProductora.value = p.productora;

      editId = id;
      modal.classList.remove('hidden');
    };

    modalCerrar.addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    formModal.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (editId === null) return;

      const data = {
        nombre: modalNombre.value,
        year: parseInt(modalYear.value),
        genero: modalGenero.value,
        director: modalDirector.value,
        presupuesto: parseFloat(modalPresupuesto.value),
        productora: modalProductora.value
      };

      await fetch(`${API_URL}/${editId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });

      modal.classList.add('hidden');
      editId = null;
      cargarPeliculas();
    });


    window.cancelarEdicion = () => {
      editId = null;
      formTitulo.textContent = "Agregar Película";
      btnCancelar.classList.add('hidden');
      form.reset();
    };

    window.eliminarPelicula = async (id) => {
      console.log("Quieres eliminarlo?...");

      if (confirm("¿Seguro que quieres eliminar esta película?")) {
        const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.error) alert(data.error);
        else alert('Película eliminada correctamente');
        cargarPeliculas();
      }
    };

    cargarPeliculas();

    const logoutBtn = document.querySelector('#logout-btn');

    logoutBtn.addEventListener('click', async () => {
        await fetch('/logout', { method: 'POST' });
        localStorage.removeItem('token');  // <-- borrar token del storage
        window.location.href = '/';
    });


  </script>
</body>
</html>